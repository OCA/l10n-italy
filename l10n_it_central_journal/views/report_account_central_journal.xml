<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>
        <template id="minimal_layout" inherit_id="report.minimal_layout">
            <xpath expr="//t[@t-if='subst is True']" position="replace">
                <t t-if="subst is True">
                    <script>
                        function subst() {
                            var vars = {};
                            var x = document.location.search.substring(1).split('&amp;');
                            for (var i in x) {
                                var z = x[i].split('=', 2);
                                vars[z[0]] = unescape(z[1]);
                            }
                            var x=['frompage', 'topage', 'page', 'webpage', 'section', 'subsection', 'subsubsection'];
                            var page_base = document.getElementById('l10n_it_count_fiscal_page_base')
                            for (var i in x) {
                                var y = document.getElementsByClassName(x[i]);
                                fiscal_page_base = 0
                                if (page_base!=null) {
                                    if (page_base.innerHTML) {
                                        fiscal_page_base = parseInt(page_base.innerHTML);
                                    }
                                }
                                for (var j=0; j&lt;y.length; ++j) {
                                    if (page_base!=null) {
                                        y[j].textContent = parseInt(eval(vars[x[i]]) + fiscal_page_base);
                                    }
                                    else
                                    {
                                        y[j].textContent = vars[x[i]];
                                    }
                                }
                            }
                        }
                    </script>
                </t>
            </xpath>
        </template>

        <template id="report_giornale">
            <t t-call="report.html_container">
                <t t-set="title" t-value="'Stampa libro giornale'"/>
                <t t-set="fiscal_page_base" t-value="l10n_it_count_fiscal_page_base"/>
                <t t-set="l10n_it_count_fiscal_year" t-value="year_footer"/>
                <t t-call="l10n_it_central_journal.internal_layout_ice">
                    <div class="page">
                        <t t-set="number_row" t-value="print_row"/>
                        <t t-set="counter" t-value="start_row"/>
                        <t t-set="save_move_id" t-value="0"/>
                        <t t-set="tot_credit" t-value="progressive_credit"/>
                        <t t-set="tot_debit" t-value="progressive_debit"/>
                        <t t-set="class_new_move" t-value="''"/>

                        <t t-foreach="get_move(data['ids'],number_row)" t-as="line_main">
                            <table style="width:100%; font-size: 8px !important;" cellspacing="0">
                                <style>
                                    table {border: 0px;}
                                    thead {background: #F5F5F5;}
                                    .left_without_line {
                                    text-align:left; vertical-align:text-top; padding:5px;
                                    }
                                    .right_without_line {
                                    text-align:right; vertical-align:text-top; padding:5px;
                                    }
                                    .new_move {
                                    border-top: 1px dotted grey;
                                    }
                                </style>
                                <thead>
                                    <tr style="page-break-inside: avoid">
                                        <th class="left_without_line">Row</th>
                                        <th class="left_without_line">Date</th>
                                        <th class="left_without_line">Ref</th>
                                        <th class="left_without_line">Account move</th>
                                        <th class="left_without_line">Account code</th>
                                        <th class="left_without_line">Account name</th>
                                        <th class="left_without_line">Name</th>
                                        <th class="right_without_line">Debit</th>
                                        <th class="right_without_line">Credit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="page-break-inside: avoid;">
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <t t-if="counter==start_row">
                                            <td class="left_without_line">Initial Balance</td>
                                            <!-- Debit -->
                                            <td class="right_without_line">
                                                <div style="page-break-inside: avoid"
                                                     t-esc="formatLang(env, tot_debit)"/>
                                            </td>
                                            <!-- Credit -->
                                            <td class="right_without_line">
                                                <div style="page-break-inside: avoid"
                                                     t-esc="formatLang(env, tot_credit)"/>
                                            </td>
                                        </t>
                                        <t t-else="">
                                            <td class="left_without_line">Partial Balance</td>
                                            <!-- Debit -->
                                            <td class="right_without_line">
                                                <div style="page-break-inside: avoid"
                                                     t-esc="formatLang(env, tot_debit)"/>
                                            </td>
                                            <!-- Credit -->
                                            <td class="right_without_line">
                                                <div style="page-break-inside: avoid"
                                                     t-esc="formatLang(env, tot_credit)"/>
                                            </td>
                                        </t>
                                    </tr>
                                    <t t-foreach="line_main" t-as="line">

                                        <t t-set="counter" t-value="counter + 1"/>
                                        <t t-set="tot_credit" t-value="tot_credit + line.credit"/>
                                        <t t-set="tot_debit" t-value="tot_debit + line.debit"/>
                                        <t t-if="line.move_id.id != save_move_id">
                                            <t t-set="class_new_move" t-value="'new_move'"/>
                                        </t>
                                        <t t-if="line.move_id.id == save_move_id">
                                            <t t-set="class_new_move" t-value="''"/>
                                        </t>

                                        <tr style="page-break-inside: avoid;" t-att-class="class_new_move">
                                            <!-- Row -->
                                            <td class="left_without_line">
                                                <div style="page-break-inside: avoid" t-esc="counter"/>
                                            </td>
                                            <!-- Date -->
                                            <td class="left_without_line">
                                                <div style="page-break-inside: avoid"
                                                     t-esc="time.strftime(date_format, time.strptime(line['date'],'%Y-%m-%d'))"/>
                                            </td>
                                            <!-- ref -->
                                            <td class="left_without_line">
                                                <div style="page-break-inside: avoid;word-break: break-all;"
                                                     t-esc="line.ref"/>
                                            </td>
                                            <!-- Account move -->
                                            <td class="left_without_line">
                                                <div style="page-break-inside: avoid;word-break: break-all;"
                                                     t-esc="line.move_id.name"/>
                                            </td>
                                            <!-- Account code -->
                                            <td class="left_without_line">
                                                <div style="page-break-inside: avoid"
                                                     t-esc="line.account_id.code"/>
                                            </td>
                                            <!-- Account name -->
                                            <td class="left_without_line">
                                                <div style="page-break-inside: avoid;word-break: break-all;"
                                                     t-esc="line.account_id.name"/>
                                            </td>
                                            <!-- Name -->
                                            <td class="left_without_line">
                                                <t t-if="line.account_id.user_type_id.type in ['receivable', 'payable']">
                                                    <div style="page-break-inside: avoid;word-break: break-all;"
                                                         t-esc="line.partner_id.name"/>
                                                </t>
                                                <t t-else="">
                                                    <div style="page-break-inside: avoid;word-break: break-all;"
                                                         t-esc="line.name"/>
                                                </t>
                                            </td>
                                            <!-- Debit -->
                                            <td class="right_without_line">
                                                <div style="page-break-inside: avoid"
                                                     t-esc="formatLang(env, line.debit)"/>
                                            </td>
                                            <!-- Credit -->
                                            <td class="right_without_line">
                                                <div style="page-break-inside: avoid"
                                                     t-esc="formatLang(env, line.credit)"/>
                                            </td>
                                        </tr>
                                        <t t-set="save_move_id" t-value="line.move_id.id"/>
                                    </t>
                                </tbody>
                                <t t-set="class_new_move" t-value="'new_move'"/>
                                <t t-if="counter==len(data['ids'])">
                                    <tr style="page-break-inside: avoid;" t-att-class="class_new_move">
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line">Final Balance</td>

                                        <!-- Debit -->
                                        <td class="right_without_line">
                                            <div style="page-break-inside: avoid"
                                                 t-esc="formatLang(env, tot_debit)"/>
                                        </td>
                                        <!-- Credit -->
                                        <td class="right_without_line">
                                            <div style="page-break-inside: avoid"
                                                 t-esc="formatLang(env, tot_credit)"/>
                                        </td>
                                    </tr>
                                </t>
                                <t t-else="counter % number_row == 0">
                                    <t t-set="fiscal_page_base" t-value="fiscal_page_base+1"/>
                                    <p style="page-break-after:always"/>
                                    <tr style="page-break-inside: avoid;" t-att-class="class_new_move">
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line"></td>
                                        <td class="left_without_line">Balance Page</td>

                                        <!-- Debit -->
                                        <td class="right_without_line">
                                            <div style="page-break-inside: avoid"
                                                 t-esc="formatLang(env, tot_debit)"/>
                                        </td>
                                        <!-- Credit -->
                                        <td class="right_without_line">
                                            <div style="page-break-inside: avoid"
                                                 t-esc="formatLang(env, tot_credit)"/>
                                        </td>
                                    </tr>
                                </t>

                            </table>
                            <t t-if="counter % number_row == 0">
                                <p style="page-break-after: always;"/>
                            </t>
                        </t>
                    </div>

                    <t t-set="save_move_id"
                       t-value="save_print_info(daterange,print_state,date_move_line_to,counter,tot_debit,tot_credit,fiscal_page_base)"/>
                </t>
            </t>

        </template>

        <template id="internal_layout_ice" inherit_id="l10n_it_account.internal_layout">
            <xpath expr="//div[@class='footer']" position="replace">
                <div class="footer">
                    <div class="row">
                        <div class="col-xs-4"></div>
                        <div class="col-xs-4 col-xs-offset-4 text-right">
                            <span style="display: none;" id="l10n_it_count_fiscal_page_base"
                                  t-esc="l10n_it_count_fiscal_page_base" />
                            <ul class="list-inline">Esercizio:

                                <t t-if="l10n_it_count_fiscal_year">
                                    <span t-esc="l10n_it_count_fiscal_year"/>
                                </t>
                                <t t-if="not l10n_it_count_fiscal_year">
                                    <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%Y')"/>
                                </t>
                                / Pag: <span class="page"/>
                            </ul>
                        </div>
                    </div>
                </div>

            </xpath>
        </template>
</data>
</openerp>
